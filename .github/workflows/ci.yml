name: CI

on:
  push:
    branches: [main, "release/**"]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".vscode/**"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: [main, "release/**"]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".vscode/**"
      - "LICENSE"
      - ".gitignore"

env:
  NODE_VERSION: "22"
  DOCKERHUB_IMAGE: khak1s/arr-dashboard

jobs:
  # Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Version read from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Cache Turbo build
        uses: actions/cache@v5
        with:
          path: .turbo
          key: turbo-lint-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            turbo-lint-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies for vulnerabilities
        run: pnpm audit --audit-level=high

      - name: Generate Prisma Client
        run: cd apps/api && pnpm exec prisma generate

      - name: Build shared package
        run: pnpm --filter @arr/shared run build

      - name: Run linting
        run: pnpm run lint

      - name: Run type checking
        run: pnpm run typecheck

  # Unit and Integration Tests
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Cache Turbo build
        uses: actions/cache@v5
        with:
          path: .turbo
          key: turbo-test-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            turbo-test-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: cd apps/api && pnpm exec prisma generate

      - name: Build shared package
        run: pnpm --filter @arr/shared run build

      - name: Run tests
        run: pnpm run test

  # End-to-End Tests with Playwright (sharded for parallelism)
  # Reduced to 2 shards - balances parallelism vs startup overhead
  e2e:
    name: E2E Tests (${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 12
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2]
        shardTotal: [2]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Cache Turbo build
        uses: actions/cache@v5
        with:
          path: .turbo
          key: turbo-e2e-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            turbo-e2e-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: cd apps/api && pnpm exec prisma generate

      - name: Build shared package
        run: pnpm --filter @arr/shared run build

      - name: Cache Playwright Browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright System Dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Setup database
        run: cd apps/api && pnpm exec prisma db push
        env:
          DATABASE_URL: file:./test.db

      - name: Run E2E tests
        run: |
          # Start API server in background (disable rate limiting for E2E tests)
          (cd apps/api && DATABASE_URL=file:./test.db API_RATE_LIMIT_MAX=10000 LOG_LEVEL=warn pnpm run dev) &
          API_PID=$!

          # Start Web server in background
          (cd apps/web && pnpm run dev) &
          WEB_PID=$!

          # Wait for servers with faster polling
          echo "Waiting for servers to start..."
          for i in {1..40}; do
            API_OK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health 2>/dev/null || echo "000")
            WEB_OK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
            if [ "$API_OK" = "200" ] && [ "$WEB_OK" != "000" ]; then
              echo "Both servers ready! (API: $API_OK, Web: $WEB_OK)"
              break
            fi
            [ $((i % 5)) -eq 0 ] && echo "Waiting... ($i/40) API=$API_OK WEB=$WEB_OK"
            sleep 1
          done

          # Run the E2E tests (sharded)
          pnpm exec playwright test --project=chromium --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
          EXIT_CODE=$?

          # Cleanup
          kill $API_PID $WEB_PID 2>/dev/null || true
          exit $EXIT_CODE
        env:
          NODE_ENV: test
          CI: true

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-report-${{ matrix.shardIndex }}
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Screenshots
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: test-screenshots-${{ matrix.shardIndex }}
          path: test-results/
          retention-days: 7

  # Docker Build Test (validates Dockerfile and warms registry cache)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test, e2e]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Only login for internal PRs/pushes (fork PRs don't have access to secrets)
      - name: Log in to Docker Hub (for cache)
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build with cache - fork PRs can read public cache but won't write to it
      - name: Build Docker image (amd64 only, warms cache for docker-dev)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: arr-dashboard:ci-test
          cache-from: type=registry,ref=${{ env.DOCKERHUB_IMAGE }}:buildcache-linux-amd64
          cache-to: ${{ (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository) && format('type=registry,ref={0}:buildcache-linux-amd64,mode=max', env.DOCKERHUB_IMAGE) || '' }}
