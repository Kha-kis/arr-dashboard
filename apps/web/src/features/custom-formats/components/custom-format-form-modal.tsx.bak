/**
 * Custom Format Form Modal
 * Comprehensive form for creating/editing custom formats with tabs
 */

"use client";

import { useState, useEffect, useMemo } from "react";
import type { CustomFormat, CustomFormatSpecification } from "@arr/shared";
import {
	Dialog,
	DialogContent,
	DialogHeader,
	DialogTitle,
	DialogDescription,
	DialogFooter,
	Button,
	Input,
	Tabs,
	TabsList,
	TabsTrigger,
	TabsContent,
	Badge,
} from "../../../components/ui";
import { cn } from "../../../lib/utils";
import { SpecificationFields } from "./specification-fields";
import { useCustomFormatSchema } from "../../../hooks/api/useCustomFormats";

/**
 * Transform form data to clean export format (for JSON preview)
 * Matches the format used by Radarr/Sonarr export and TRaSH guides
 */
function transformToExportFormat(formData: Omit<CustomFormat, "id">): any {
	return {
		name: formData.name,
		includeCustomFormatWhenRenaming: formData.includeCustomFormatWhenRenaming,
		specifications: formData.specifications?.map((spec) => {
			// Convert fields array to object (key-value pairs)
			const fieldsObj: Record<string, any> = {};
			if (Array.isArray(spec.fields)) {
				for (const field of spec.fields) {
					if (field.name && field.value !== undefined) {
						fieldsObj[field.name] = field.value;
					}
				}
			} else if (spec.fields && typeof spec.fields === 'object') {
				// Already in object format
				Object.assign(fieldsObj, spec.fields);
			}

			return {
				name: spec.name,
				implementation: spec.implementation,
				negate: spec.negate,
				required: spec.required,
				fields: fieldsObj,
			};
		}) || [],
	};
}

interface CustomFormatFormModalProps {
	isOpen: boolean;
	onClose: () => void;
	onSubmit: (data: Omit<CustomFormat, "id">) => void | Promise<void>;
	initialData?: CustomFormat | null;
	isSubmitting?: boolean;
	instanceId?: string;
	instances?: Array<{ instanceId: string; instanceLabel: string; instanceService: string }>;
	onInstanceChange?: (instanceId: string) => void;
}

export function CustomFormatFormModal({
	isOpen,
	onClose,
	onSubmit,
	initialData,
	isSubmitting = false,
	instanceId,
	instances = [],
	onInstanceChange,
}: CustomFormatFormModalProps) {
	const [activeTab, setActiveTab] = useState("details");
	const [formData, setFormData] = useState<Omit<CustomFormat, "id">>({
		name: "",
		includeCustomFormatWhenRenaming: false,
		specifications: [],
	});

	// Fetch schema for field definitions
	const { data: schema } = useCustomFormatSchema(instanceId);

	// Initialize form data when modal opens or initialData changes
	useEffect(() => {
		if (initialData) {
			const { id, ...data } = initialData;
			setFormData(data);
		} else {
			setFormData({
				name: "",
				includeCustomFormatWhenRenaming: false,
				specifications: [],
			});
		}
	}, [initialData, isOpen]);

	const handleSubmit = async (e: React.FormEvent) => {
		e.preventDefault();
		await onSubmit(formData);
	};

	const addSpecification = () => {
		// Get field definitions from schema for default implementation
		const defaultImplementation = "ReleaseTitleSpecification";
		const implementationSchema = schema?.find(
			(s: any) => s.implementation === defaultImplementation
		);
		const fields = implementationSchema?.fields || [];

		setFormData((prev) => ({
			...prev,
			specifications: [
				...prev.specifications,
				{
					name: "New Specification",
					implementation: defaultImplementation,
					negate: false,
					required: false,
					fields: fields,
				},
			],
		}));
	};

	const updateSpecification = (
		index: number,
		updates: Partial<CustomFormatSpecification>,
	) => {
		setFormData((prev) => ({
			...prev,
			specifications: prev.specifications.map((spec, i) => {
				if (i !== index) return spec;

				// If implementation is changing, update fields from schema
				if (updates.implementation && updates.implementation !== spec.implementation) {
					const implementationSchema = schema?.find(
						(s: any) => s.implementation === updates.implementation
					);
					const fields = implementationSchema?.fields || [];
					return { ...spec, ...updates, fields };
				}

				return { ...spec, ...updates };
			}),
		}));
	};

	const deleteSpecification = (index: number) => {
		setFormData((prev) => ({
			...prev,
			specifications: prev.specifications.filter((_, i) => i !== index),
		}));
	};

	if (!isOpen) return null;

	return (
		<Dialog open={isOpen} onOpenChange={onClose}>
			<DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
				<DialogHeader>
					<DialogTitle>
						{initialData ? "Edit Custom Format" : "Create Custom Format"}
					</DialogTitle>
					<DialogDescription>
						{initialData
							? "Modify the custom format details, specifications, and scoring."
							: "Create a new custom format with specifications and scoring."}
					</DialogDescription>
				</DialogHeader>

				<form onSubmit={handleSubmit} className="flex-1 flex flex-col overflow-hidden">
					<Tabs defaultValue="details" className="flex-1 flex flex-col overflow-hidden">
						<TabsList className="w-full justify-start">
							<TabsTrigger value="details">Details</TabsTrigger>
							<TabsTrigger value="specifications">
								Specifications ({formData.specifications.length})
							</TabsTrigger>
							<TabsTrigger value="json">JSON Preview</TabsTrigger>
						</TabsList>

						{/* Details Tab */}
						<TabsContent value="details" className="flex-1 overflow-y-auto p-4 space-y-4">
							<div className="space-y-2">
								<label htmlFor="name" className="text-sm font-medium text-fg">
									Name <span className="text-danger">*</span>
								</label>
								<Input
									id="name"
									type="text"
									value={formData.name}
									onChange={(e) =>
										setFormData((prev) => ({ ...prev, name: e.target.value }))
									}
									placeholder="e.g., DV HDR10+"
									required
								/>
							</div>

							<div className="flex items-center gap-2">
								<input
									id="includeWhenRenaming"
									type="checkbox"
									checked={formData.includeCustomFormatWhenRenaming}
									onChange={(e) =>
										setFormData((prev) => ({
											...prev,
											includeCustomFormatWhenRenaming: e.target.checked,
										}))
									}
									className="h-4 w-4 rounded border-border bg-bg-subtle text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2"
								/>
								<label
									htmlFor="includeWhenRenaming"
									className="text-sm font-medium text-fg cursor-pointer"
								>
									Include when renaming
								</label>
							</div>
							<p className="text-xs text-fg-muted">
								When enabled, this custom format name will be included in renamed
								files.
							</p>
						</TabsContent>

						{/* Specifications Tab */}
						<TabsContent
							value="specifications"
							className="flex-1 overflow-y-auto p-4 space-y-4"
						>
							<div className="flex items-center justify-between">
								<p className="text-sm text-fg-muted">
									Define conditions that must match for this custom format to apply.
								</p>
								<Button type="button" size="sm" onClick={addSpecification}>
									Add Specification
								</Button>
							</div>

							{formData.specifications.length === 0 ? (
								<div className="flex flex-col items-center justify-center py-12 border border-dashed border-border rounded-lg bg-bg-subtle/30">
									<p className="text-fg-muted mb-2">No specifications yet</p>
									<p className="text-xs text-fg-subtle mb-4">
										Add conditions to define when this custom format applies
									</p>
									<Button type="button" variant="secondary" onClick={addSpecification}>
										Add First Specification
									</Button>
								</div>
							) : (
								<div className="space-y-3">
									{formData.specifications.map((spec, index) => (
										<div
											key={index}
											className="border border-border rounded-lg p-4 bg-bg-subtle/30 space-y-3"
										>
											<div className="flex items-start justify-between gap-2">
												<div className="flex-1 space-y-3">
													<div className="space-y-2">
														<label className="text-sm font-medium text-fg">
															Name
														</label>
														<Input
															type="text"
															value={spec.name}
															onChange={(e) =>
																updateSpecification(index, {
																	name: e.target.value,
																})
															}
															placeholder="Specification name"
														/>
													</div>

													<div className="space-y-2">
														<div className="flex items-center justify-between">
															<label className="text-sm font-medium text-fg">
																Implementation
															</label>
															{/* Info link if available in schema */}
															{schema && Array.isArray(schema) && (() => {
																const schemaItem = schema.find(
																	(s: any) => s.implementation === spec.implementation
																);
																return schemaItem?.infoLink ? (
																	<a
																		href={schemaItem.infoLink}
																		target="_blank"
																		rel="noopener noreferrer"
																		className="text-xs text-primary hover:underline"
																	>
																		More Info â†—
																	</a>
																) : null;
															})()}
														</div>
														<select
															value={spec.implementation}
															onChange={(e) =>
																updateSpecification(index, {
																	implementation: e.target.value,
																})
															}
															className="w-full rounded-lg border border-border bg-bg px-3 py-2 text-sm text-fg focus:ring-2 focus:ring-primary focus:ring-offset-2"
														>
															{schema && Array.isArray(schema) ? (
																schema.map((schemaItem: any) => (
																	<option
																		key={schemaItem.implementation}
																		value={schemaItem.implementation}
																	>
																		{schemaItem.implementationName || schemaItem.implementation}
																	</option>
																))
															) : (
																<option value={spec.implementation}>
																	{spec.implementation}
																</option>
															)}
														</select>
														{/* Presets if available */}
														{schema && Array.isArray(schema) && (() => {
															const schemaItem = schema.find(
																(s: any) => s.implementation === spec.implementation
															);
															const presets = schemaItem?.presets;
															return presets && Array.isArray(presets) && presets.length > 0 ? (
																<div className="flex flex-wrap gap-2">
																	<span className="text-xs text-fg-muted">Presets:</span>
																	{presets.map((preset: any) => (
																		<button
																			key={preset.name}
																			type="button"
																			onClick={() => {
																				// Apply preset fields
																				updateSpecification(index, {
																					name: preset.name,
																					fields: preset.fields || preset,
																				});
																			}}
																			className="text-xs px-2 py-1 rounded border border-border bg-bg-subtle hover:bg-bg-muted hover:border-primary transition-colors"
																		>
																			{preset.name}
																		</button>
																	))}
																</div>
															) : null;
														})()}
													</div>

													{/* Dynamic fields based on specification type */}
													{spec.fields && (
														<div className="space-y-2">
															<label className="text-sm font-medium text-fg">
																Specification Fields
															</label>
															<SpecificationFields
																fields={spec.fields}
																onChange={(updatedFields) =>
																	updateSpecification(index, {
																		fields: updatedFields,
																	})
																}
															/>
														</div>
													)}

													<div className="grid grid-cols-2 gap-3">
														<div className="flex items-center gap-2">
															<input
																type="checkbox"
																id={`negate-${index}`}
																checked={spec.negate}
																onChange={(e) =>
																	updateSpecification(index, {
																		negate: e.target.checked,
																	})
																}
																className="h-4 w-4 rounded border-border bg-bg-subtle text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2"
															/>
															<label
																htmlFor={`negate-${index}`}
																className="text-sm text-fg cursor-pointer"
															>
																Negate
															</label>
														</div>

														<div className="flex items-center gap-2">
															<input
																type="checkbox"
																id={`required-${index}`}
																checked={spec.required}
																onChange={(e) =>
																	updateSpecification(index, {
																		required: e.target.checked,
																	})
																}
																className="h-4 w-4 rounded border-border bg-bg-subtle text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2"
															/>
															<label
																htmlFor={`required-${index}`}
																className="text-sm text-fg cursor-pointer"
															>
																Required
															</label>
														</div>
													</div>
												</div>

												<Button
													type="button"
													variant="ghost"
													size="sm"
													onClick={() => deleteSpecification(index)}
													className="text-danger hover:bg-danger/10"
												>
													Delete
												</Button>
											</div>
										</div>
									))}
								</div>
							)}
						</TabsContent>

						{/* JSON Preview Tab */}
						<TabsContent value="json" className="flex-1 overflow-y-auto p-4">
							<div className="rounded-lg border border-border bg-bg-subtle/30 p-4">
								<pre className="text-xs text-fg-muted overflow-x-auto">
									{JSON.stringify(transformToExportFormat(formData), null, 2)}
								</pre>
							</div>
						</TabsContent>
					</Tabs>

					<DialogFooter className="mt-4">
						<Button type="button" variant="ghost" onClick={onClose}>
							Cancel
						</Button>
						<Button type="submit" disabled={isSubmitting || !formData.name}>
							{isSubmitting
								? initialData
									? "Updating..."
									: "Creating..."
								: initialData
									? "Update"
									: "Create"}
						</Button>
					</DialogFooter>
				</form>
			</DialogContent>
		</Dialog>
	);
}
