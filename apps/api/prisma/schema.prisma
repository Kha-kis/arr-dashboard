generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ServiceType {
  SONARR
  RADARR
  PROWLARR
}

model User {
  id                  String                @id @default(cuid())
  username            String                @unique
  hashedPassword      String?               // Optional: users can authenticate via OIDC or passkeys
  mustChangePassword  Boolean               @default(false)
  failedLoginAttempts Int                   @default(0)
  lockedUntil         DateTime?
  encryptedTmdbApiKey String?
  tmdbEncryptionIv    String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  sessions            Session[]
  oidcAccounts        OIDCAccount[]
  webauthnCredentials WebAuthnCredential[]
  trashSettings       TrashSettings?
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model ServiceTag {
  id        String            @id @default(cuid())
  name      String            @unique
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  instances ServiceInstanceTag[]
}

model ServiceInstance {
  id              String              @id @default(cuid())
  service         ServiceType
  label           String
  baseUrl         String
  encryptedApiKey String
  encryptionIv    String
  isDefault       Boolean             @default(false)
  enabled         Boolean             @default(true)
  defaultQualityProfileId Int?
  defaultLanguageProfileId Int?
  defaultRootFolderPath String?
  defaultSeasonFolder Boolean?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  tags            ServiceInstanceTag[]
  trashSyncHistory TrashSyncHistory[]
  trashBackups     TrashBackup[]
  trashSchedules   TrashSyncSchedule[]

  @@index([service])
}

model ServiceInstanceTag {
  instanceId String
  tagId      String
  assignedAt DateTime @default(now())

  instance ServiceInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  tag      ServiceTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([instanceId, tagId])
}

// OIDC Provider Configuration (stored in database, managed via UI)
model OIDCProvider {
  id                      String   @id @default(cuid())
  type                    String   // "authelia", "authentik", "generic"
  displayName             String   // Display name shown on login button
  clientId                String
  encryptedClientSecret   String   // AES-256-GCM encrypted
  clientSecretIv          String   // Initialization vector for encryption
  issuer                  String   // OIDC issuer URL for discovery
  redirectUri             String   // Callback URL
  scopes                  String   @default("openid,email,profile") // Comma-separated
  enabled                 Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([type])
  @@map("oidc_providers")
}

// OIDC Account for external authentication providers (Authelia, Authentik, etc.)
model OIDCAccount {
  id              String   @id @default(cuid())
  userId          String
  provider        String   // e.g., "authelia", "authentik", "generic"
  providerUserId  String   // The user ID from the OIDC provider
  providerEmail   String?  // Email from the OIDC provider
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oidc_accounts")
}

// WebAuthn credentials for passkey authentication
model WebAuthnCredential {
  id                String   @id // Base64url encoded credential ID
  userId            String
  publicKey         String   // Base64url encoded public key
  counter           Int      @default(0) // Signature counter for security
  transports        String?  // JSON array of allowed transports (usb, nfc, ble, internal)
  backedUp          Boolean  @default(false) // Whether credential is backed up to cloud
  friendlyName      String?  // User-provided name (e.g., "iPhone", "YubiKey")
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webauthn_credentials")
}

enum BackupIntervalType {
  DISABLED
  HOURLY
  DAILY
  WEEKLY
}

// Backup settings (singleton table, only one row)
model BackupSettings {
  id                Int                 @id @default(1)
  enabled           Boolean             @default(false)
  intervalType      BackupIntervalType  @default(DISABLED)
  intervalValue     Int                 @default(24) // Hours for HOURLY, days for DAILY (1-7), 1 for WEEKLY
  retentionCount    Int                 @default(7)  // Number of scheduled backups to keep
  lastRunAt         DateTime?
  nextRunAt         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("backup_settings")
}

// ============================================================================
// TRaSH Guides Integration Models
// ============================================================================

// TRaSH Guides cache storage for fetched JSON data from GitHub
model TrashCache {
  id            String      @id @default(cuid())
  serviceType   ServiceType // RADARR, SONARR
  configType    String      // CUSTOM_FORMATS, CF_GROUPS, QUALITY_SIZE, NAMING
  data          String      // JSON blob (will be compressed in application layer)
  version       Int         @default(1)
  fetchedAt     DateTime    @default(now())
  lastCheckedAt DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([serviceType, configType])
  @@index([serviceType, configType])
  @@map("trash_cache")
}

// User-created templates for TRaSH configurations
model TrashTemplate {
  id          String      @id @default(cuid())
  userId      String
  name        String
  description String?
  serviceType ServiceType // RADARR, SONARR
  configData  String      // JSON blob with user customizations
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?   // Soft delete

  syncHistory TrashSyncHistory[]
  schedules   TrashSyncSchedule[]

  @@index([userId])
  @@index([serviceType])
  @@map("trash_templates")
}

// Sync operation history and audit log
model TrashSyncHistory {
  id          String    @id @default(cuid())
  instanceId  String
  templateId  String?
  userId      String
  syncType    String    // MANUAL, SCHEDULED
  status      String    // SUCCESS, PARTIAL_SUCCESS, FAILED
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?      // seconds

  // Sync statistics
  configsApplied   Int @default(0)
  configsFailed    Int @default(0)
  configsSkipped   Int @default(0)

  // Detailed sync data (JSON blobs)
  appliedConfigs String  // JSON array of applied config IDs
  failedConfigs  String? // JSON array with error details
  errorLog       String? // Full error log

  // Rollback reference
  backupId       String?
  rolledBack     Boolean @default(false)
  rolledBackAt   DateTime?

  instance   ServiceInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  template   TrashTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  backup     TrashBackup?      @relation(fields: [backupId], references: [id], onDelete: SetNull)

  @@index([instanceId])
  @@index([templateId])
  @@index([userId])
  @@index([startedAt])
  @@map("trash_sync_history")
}

// Backup snapshots of instance configs before sync operations
model TrashBackup {
  id         String      @id @default(cuid())
  instanceId String
  userId     String
  backupData String      // JSON blob (compressed) - full instance config snapshot
  createdAt  DateTime    @default(now())
  expiresAt  DateTime?   // Auto-delete after retention period

  instance    ServiceInstance    @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  syncHistory TrashSyncHistory[]

  @@index([instanceId])
  @@index([createdAt])
  @@map("trash_backups")
}

// Scheduled sync configuration for automated TRaSH updates
model TrashSyncSchedule {
  id          String      @id @default(cuid())
  instanceId  String?
  templateId  String?
  userId      String
  enabled     Boolean     @default(true)

  // Schedule configuration
  frequency   String      // DAILY, WEEKLY, MONTHLY
  lastRunAt   DateTime?
  nextRunAt   DateTime?

  // Sync behavior
  autoApply   Boolean     @default(false) // Auto-apply or just notify
  notifyUser  Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  instance ServiceInstance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  template TrashTemplate?   @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([templateId])
  @@index([nextRunAt])
  @@map("trash_sync_schedules")
}

// User preferences for TRaSH Guides feature
model TrashSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique

  // Update check settings
  checkFrequency     Int      @default(12) // hours
  autoRefreshCache   Boolean  @default(true)

  // Notification preferences
  notifyOnUpdates    Boolean  @default(true)
  notifyOnSyncFail   Boolean  @default(true)

  // Backup settings
  backupRetention    Int      @default(10) // number of backups to keep per instance

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("trash_settings")
}
